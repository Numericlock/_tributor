<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>Dock</title>
    <link rel="stylesheet" href="stylesheets/nav.css">
</head>

<body>
 <p style="height:300px;"></p>
    <ul id="sns">
        <li>
            <a class="pocket" href="#">pocket</a>
        </li>
        <li>
            <a class="facebook" href="#">facebook</a>
        </li>
        <li>
            <a class="twitter" href="#">twitter</a>
        </li>
        <li>
            <a class="github" href="#">github</a>
        </li>
        <li>
            <a class="googlep" href="#">google+</a>
        </li>
        <li>
            <a class="line" href="#">line</a>
        </li>
        <li>
            <a class="hateb" href="#">hateb</a>
        </li>
        <li>
            <a class="feedly" href="#">feedly</a>
        </li>
    </ul>
    <script>

    // マウスホバーした時の拡大率
    var zoom = 2;

    (function(zoom) {
        'use strict'

        //
        if('ontouchstart' in window) return;
        var anime;
        var mouseX;

        var dock = document.getElementById('sns');
        dock.classList.add('dock');
        var icons = dock.children;
        var defaultHeight = icons[0].offsetHeight;
        var bound = defaultHeight * 3.14;
        dock.style.height = defaultHeight * (icons.length -1) +'px';
        dock.style.width = defaultHeight +'px';
        [].forEach.call(icons, function(icon, i) {
            var span = document.createElement('span');
            var anchor = icon.getElementsByTagName('a')[0];
            var text = anchor.textContent;
            span.textContent = text;
            icon.appendChild(span);
            anchor.textContent = '';

            // icon.style.transition = ...でもOK
            icon.setAttribute('style', 'transition:.3s;top:' + i * defaultHeight + 'px'); //読み込み時配置
        });

        // 50/sのフレームレートで実行される、各アイコンの位置や大きさを決めている関数
        function scaling(x) {
            for(var i = icons.length; i--;) {
                var icon = icons[i];
                var distance = (i * defaultHeight + defaultHeight / 2) - x;
                if(-bound < distance && distance < bound) {
                    var rad = distance / defaultHeight * .5;
                    var currentScale = icon.getBoundingClientRect().height / icon.offsetHeight;
                    var scale = currentScale + (1 + (zoom - 1) * Math.cos(rad) - currentScale)/5;
                    var currentTop = icon.offsetTop;
                    var top = currentTop + (i * defaultHeight + 2 * (zoom - 1) * defaultHeight * Math.sin(rad) -currentTop)/5;
                    // icon.style.top .., icon.style.transform = ..じゃないのは、速度を
                    // 優先したため
                    icon.setAttribute('style', 'top:' + top + 'px;transform:scale(' + scale + ')');//ホバー時
                } else {
                    var top;
                    if(-bound < distance) {
                        top = i * defaultHeight + 2.05 * (zoom - 1) * defaultHeight;
                    } else {
                        top = i * defaultHeight - 2.05 * (zoom - 1) * defaultHeight;
                    }
                    var currentTop = icon.offsetTop;
                    var currentScale = icon.getBoundingClientRect().height / icon.offsetHeight;
                    icon.setAttribute('style', 'top:' + (currentTop + (top - currentTop)/5) + 'px;transform:scale('+(currentScale + (1-currentScale)/5)+')'); //ホバー時
                }
            }
        }

        dock.addEventListener('mousemove', function(e) {
            mouseX = e.clientX - dock.getBoundingClientRect().top;
        });

        // dockの上にマウスが入ったときに各アイコンの拡大処理をスタート
        dock.addEventListener('mouseenter', function(e) {
            // フレームレート 50/s で各アイコンを拡大/縮小する
            anime = setInterval(function() {
                scaling(mouseX);
            }, 20);

            // dock自体も拡大しないと、iconの隙間にマウスが入ったときに
            // 不意に縮小する
            dock.style.height = defaultHeight * zoom + 'px';
            dock.style.marginTop = -(zoom - 1) * defaultHeight + 'px';
        });

        // マウスがdockから離れたとき
        dock.addEventListener('mouseleave', function(e) {
            clearInterval(anime);
            dock.style.height = defaultHeight + 'px';
            dock.style.marginTop = 0;

            // 通常の状態に戻る縮小処理はJavaScriptじゃなくてcssのtransitionでやってる
            // jsでやると、全ての処理が終了するまでanime処理を終わらせられなくて、その間に
            // またmouseenterになったときの処理が面倒
            for(var i = icons.length; i--;) {
                // tansform:scaleは書かなくても、setAttributeでやっていると
                // transform属性自体削除されているのでscale(1)扱いになる
                icons[i].setAttribute('style', 'transition: .3s;top:' + i * defaultHeight + 'px');
            }
        });
    }(zoom));
    </script>
</body>
</html>